<!doctype html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slick.jsのサンプル</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <link rel="stylesheet" href="../assets/css/carousel.css" />
</head>

<body>
    <div class="wrapper">
        <h1>Slick.jsのサンプル</h1>

        <!-- くま・ねこ・ひよこ：そのまま -->
        <h2>「くまさんとねこさんとひよこさん」</h2>
        <div class="sample-slick">
            <div class="slick carousel">
                <div class="item">
                    <img src="../assets/images/bear_story1.png" alt="お散歩のシーン" />
                    <p class="caption">くまさんとねこさんとひよこさん　なかよくさんぽ</p>
                </div>
                <div class="item">
                    <img src="../assets/images/bear_story2.png" alt="ピクニックのシーン" />
                    <p class="caption">みんなでひなたで　おいしいごはん　しあわせなひととき</p>
                </div>
                <div class="item">
                    <img src="../assets/images/bear_story3.png" alt="夕焼けのシーン" />
                    <p class="caption">ゆうやけにそまって　あしたもなかよし</p>
                </div>
            </div>
        </div>

        <!-- よるの まどわし：縦書き（PC）/ 横書き（SP）で1文字アニメ -->
        <h2>「よるの　まどわし」</h2>
        <div class="sample-slick-fade">
            <div class="slick carousel">
                <div class="item">
                    <img src="../assets/images/night_story1.png" alt="ベッドで目を覚ます少年" />
                    <p class="caption caption-v">夜、ぼくは　ふしぎな音でめをさました</p>
                </div>
                <div class="item">
                    <img src="../assets/images/night_story2.png" alt="部屋をのぞく少年" />
                    <p class="caption caption-v">そっと ドアをひらくと、くらやみのなかから なにかが よんでいる</p>
                </div>
                <div class="item">
                    <img src="../assets/images/night_story3.png" alt="赤い目の自分と向き合う少年" />
                    <p class="caption caption-v">そこに いたのは ぼくと おなじ顔の、知らない“ぼく”。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script>
        $(function () {
            // くま側
            $(".sample-slick .slick").slick({ infinite: true, autoplay: true, autoplaySpeed: 4000 });

            const $night = $(".sample-slick-fade .slick");

            // 右→左の2列に分配しつつ、1文字ずつ遅延アニメ
            function buildTwoCols($cap) {
                // 元テキスト（<br>は改行に）
                const src = ($cap.attr("data-src") || $cap.html().replace(/<br\s*\/?>/gi, "\n"));
                $cap.attr("data-src", src);

                // 器を作り直し（右列→左列の順で追加する）
                $cap.empty();
                const colRight = $('<div class="vcol"></div>').appendTo($cap);
                const colLeft = $('<div class="vcol"></div>').appendTo($cap);

                const maxH = $cap.innerHeight();  // 1列に入れられる高さ
                let index = 0;                     // アニメ遅延 0.1s刻み
                let toLeft = false;                // false:右列 / true:左列

                const lines = src.split("\n");
                lines.forEach((line, li) => {
                    for (const ch of Array.from(line)) {
                        const span = $('<span/>').text(ch)
                            .css('animationDelay', (index * 0.1) + 's');

                        const col = toLeft ? colLeft : colRight;
                        col.append(span);

                        // 溢れたら左列へ切り替え（今追加した分を左へ移す）
                        if (col[0].scrollHeight > maxH) {
                            span.detach();
                            toLeft = true;
                            colLeft.append(span);
                        }
                        index++;
                    }
                    // 行の区切り
                    if (li < lines.length - 1) {
                        const gap = $('<span class="line-gap"></span>');
                        const col = toLeft ? colLeft : colRight;
                        col.append(gap);
                        if (col[0].scrollHeight > maxH) {
                            gap.detach();
                            toLeft = true;
                            colLeft.append(gap);
                        }
                        index += 2; // 行間ぶん少し遅延
                    }
                });
            }

            // 毎回最初からアニメさせる
            function replay($cap) { buildTwoCols($cap); }

            // 初期準備：夜のキャプションを分解
            $(".sample-slick-fade .caption-v").each(function () { buildTwoCols($(this)); });

            // slickのイベントで毎回再構築
            $night.on("init", function (e, slick) {
                const $cur = $(slick.$slides.get(slick.currentSlide)).find(".caption-v");
                if ($cur.length) replay($cur);
            });
            $night.on("beforeChange", function (e, slick, current, next) {
                const $next = $(slick.$slides.get(next)).find(".caption-v");
                if ($next.length) replay($next);
            });

            // 自動再生が止まらないように
            $night.slick({
                infinite: true,
                fade: true,
                autoplay: true,
                autoplaySpeed: 5000,
                speed: 700,
                cssEase: 'ease',
                pauseOnHover: false,
                pauseOnFocus: false,
                pauseOnDotsHover: false
            });

            // 画面サイズ変更時は再レイアウト
            let timer = null;
            $(window).on('resize', function () {
                clearTimeout(timer);
                timer = setTimeout(function () {
                    const $cur = $night.find('.slick-slide.slick-current .caption-v');
                    if ($cur.length) replay($cur);
                }, 120);
            });
        });
    </script>

</body>

</html>